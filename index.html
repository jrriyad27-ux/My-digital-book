<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma Pro - Welcome to My e-book</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --paper: #fdfaf1; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #e5e7eb; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Top Bar Mode Switcher */
        .mode-switch { background: var(--primary); color: white; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; opacity: 0.6; transition: 0.3s; font-size: 14px; }
        .mode-btn.active { opacity: 1; border-bottom: 4px solid var(--accent); background: rgba(255,255,255,0.1); }

        /* Tabs & Panels */
        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 14px; color: #7f8c8d; }
        .tab.active { color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }
        
        .panel-container { background: white; padding: 12px; display: none; border-bottom: 1px solid #ddd; max-height: 40vh; overflow-y: auto; }
        .panel-container.active { display: block; }

        /* Notepad Card Styling */
        #notepad-container { display: none; padding: 15px; overflow-y: auto; flex-grow: 1; }
        .note-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .note-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 8px; }
        .otp-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .status-unused { background: #dcfce7; color: #166534; }
        .status-used { background: #fee2e2; color: #991b1b; }
        
        /* Book Mode Styling */
        #book-mode-container { display: flex; flex-direction: column; flex-grow: 1; }
        .viewer-area { flex-grow: 1; display: none; flex-direction: column; justify-content: center; align-items: center; perspective: 2000px; padding: 10px; }
        .viewer-area.active { display: flex; }
        .book-container { width: 95%; max-width: 340px; height: 50vh; position: relative; transform-style: preserve-3d; }
        .page { width: 100%; height: 100%; position: absolute; background: var(--paper); padding: 20px; box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.8s; transform-origin: left; backface-visibility: hidden; border-radius: 5px 12px 12px 5px; overflow: hidden; }
        .page.flipped { transform: rotateY(-180deg); }
        .page-content { font-size: 15px; line-height: 1.6; text-align: justify; height: 80%; overflow: hidden; }

        /* Modal for Note Content */
        #noteModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; padding: 20px; color: white; overflow-y: auto; }
        .modal-body { background: #1a1a1a; padding: 20px; border-radius: 15px; margin-top: 30px; line-height: 1.7; }

        /* UI Elements */
        input, textarea, .main-btn { width: 100%; padding: 10px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .otp-edit-btn { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

<div class="mode-switch">
    <div class="mode-btn active" id="btn-book" onclick="switchMode('book')">üìñ BOOK MODE</div>
    <div class="mode-btn" id="btn-note" onclick="switchMode('note')">üìù NOTEPAD MODE</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showPanel('writePanel', this)">Add Entry</div>
    <div class="tab" onclick="showPanel('listPanel', this)">Library / Files</div>
</div>

<div id="writePanel" class="panel-container active">
    <input type="text" id="pTitle" placeholder="Title / Chapter Name">
    <textarea id="pContent" rows="3" placeholder="Write your content or code here..."></textarea>
    <input type="text" id="pImg" placeholder="Image URL (Optional)">
    <button class="main-btn" onclick="handleSave()">Save to Cloud</button>
</div>

<div id="listPanel" class="panel-container">
    <div id="dataList">Loading...</div>
</div>

<div id="book-mode-container">
    <div class="viewer-area" id="bookViewer">
        <div class="book-container" id="bookBox">
            <div class="page" id="page-0" style="background:var(--primary); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <h1 id="coverTitle">Select a Book</h1>
                <p>Digital Library</p>
            </div>
        </div>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button onclick="prevPage()" style="padding:10px 20px; border-radius:20px; border:none;">‚ùÆ</button>
            <span id="pageCounter" style="color:var(--primary); font-weight:bold; padding-top:10px;">1/1</span>
            <button onclick="nextPage()" style="padding:10px 20px; border-radius:20px; border:none;">‚ùØ</button>
        </div>
    </div>
</div>

<div id="notepad-container"></div>

<div id="noteModal">
    <button onclick="closeModal()" style="float:right; background:red; color:white; border:none; padding:10px; border-radius:5px;">CLOSE</button>
    <div id="modalContent" class="modal-body"></div>
</div>

<audio id="flipSound" src="https://www.soundjay.com/misc/sounds/paper-flip-1.mp3" preload="auto"></audio>

<script>
    // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAHb1Zifpb1d48j-hmf4Py4XZEOzEnKx64",
  authDomain: "my-digital-85852.firebaseapp.com",
  databaseURL: "https://my-digital-85852-default-rtdb.firebaseio.com",
  projectId: "my-digital-85852",
  storageBucket: "my-digital-85852.firebasestorage.app",
  messagingSenderId: "865378510703",
  appId: "1:865378510703:web:0e3e9a61311ff8bd60ea9a"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    let bookId = urlParams.get('id');
    let currentMode = 'book';
    let currentPage = 0, totalPages = 1;

    function init() {
        if(bookId) {
            document.getElementById('coverTitle').innerText = bookId.replace(/_/g, ' ');
            document.getElementById('bookViewer').classList.add('active');
            loadBookData();
        }
        renderLibrary();
    }

    // ‡ß®. ‡¶Æ‡ßã‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® (Book vs Notepad)
    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');
        
        if(mode === 'note') {
            document.getElementById('book-mode-container').style.display = 'none';
            document.getElementById('notepad-container').style.display = 'block';
            loadNotepad();
        } else {
            document.getElementById('book-mode-container').style.display = 'flex';
            document.getElementById('notepad-container').style.display = 'none';
        }
    }

    // ‡ß©. ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ (‡¶á‡¶Æ‡ßá‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶∏‡¶π)
    function handleSave() {
        const title = document.getElementById('pTitle').value;
        const content = document.getElementById('pContent').value;
        const img = document.getElementById('pImg').value;
        
        if(!bookId) return alert("Please open or create a book first!");
        if(!title || !content) return alert("Title and Content required!");

        if(currentMode === 'note') {
            const otp = prompt("Set 1-Time OTP for this note:");
            if(!otp) return;
            db.ref('notepads/' + bookId).push({ title, content, img, otp, status: 'unused', views: 0, time: Date.now() });
            alert("Secure Note Saved!");
        } else {
            db.ref('all_books/' + bookId).push({ title, content, img });
            alert("Book Page Added!");
        }
        document.getElementById('pTitle').value = "";
        document.getElementById('pContent').value = "";
    }

    // ‡ß™. ‡¶®‡ßã‡¶ü‡¶™‡ßç‡¶Ø‡¶æ‡¶° ‡¶Æ‡ßã‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
    function loadNotepad() {
        db.ref('notepads/' + bookId).on('value', snap => {
            const container = document.getElementById('notepad-container');
            container.innerHTML = "";
            snap.forEach(child => {
                const note = child.val();
                const key = child.key;
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = `
                    <div class="note-header">
                        <span>üëÅÔ∏è Views: ${note.views || 0}</span>
                        <span class="otp-badge ${note.status==='used'?'status-used':'status-unused'}">${note.status.toUpperCase()}</span>
                    </div>
                    <h4 style="margin:5px 0;">${note.title}</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <button class="otp-edit-btn" onclick="updateOTP('${key}')">Update OTP</button>
                        <button class="main-btn" style="width:120px; margin:0;" onclick="openSecureNote('${key}')">Open</button>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    // ‡ß´. ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶®‡ßã‡¶ü ‡¶ì‡¶™‡ßá‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    function openSecureNote(key) {
        db.ref('notepads/' + bookId + '/' + key).once('value', snap => {
            const note = snap.val();
            if(note.status === 'used') return alert("OTP expired! Update OTP to reuse.");
            
            const userOTP = prompt("Enter OTP to unlock:");
            if(userOTP === note.otp) {
                db.ref('notepads/' + bookId + '/' + key).update({ status: 'used', views: (note.views || 0) + 1 });
                showModal(note);
            } else {
                alert("Wrong OTP!");
            }
        });
    }

    function showModal(note) {
        const modal = document.getElementById('noteModal');
        const content = document.getElementById('modalContent');
        modal.style.display = 'block';
        content.innerHTML = `
            <h2>${note.title}</h2>
            ${note.img ? `<img src="${note.img}" style="width:100%; border-radius:10px; margin-bottom:15px;">` : ''}
            <div style="white-space: pre-wrap; font-family: monospace; background:#000; padding:15px; border-radius:10px;">${note.content}</div>
        `;
    }

    function closeModal() { 
        document.getElementById('noteModal').style.display = 'none'; 
        location.reload(); 
    }

    function updateOTP(key) {
        const newOTP = prompt("Set new OTP for this file:");
        if(newOTP) db.ref('notepads/' + bookId + '/' + key).update({ otp: newOTP, status: 'unused' });
    }

    // --- Book Mode Old Logic ---
    function loadBookData() {
        db.ref('all_books/' + bookId).on('value', snap => {
            const data = snap.val();
            const box = document.getElementById('bookBox');
            box.querySelectorAll('.cloud-page').forEach(p => p.remove());
            let i = 1;
            for(let k in data) {
                const d = data[k];
                const div = document.createElement('div');
                div.className = 'page cloud-page';
                div.id = 'page-' + i;
                div.style.zIndex = 100 - i;
                div.innerHTML = `
                    <h4 style="margin:0; color:var(--accent);">${d.title}</h4>
                    ${d.img ? `<img src="${d.img}" style="width:100%; max-height:100px; object-fit:contain; margin:10px 0;">` : ''}
                    <div class="page-content">${d.content}</div>
                    <small style="position:absolute; bottom:10px; right:15px;">Page ${i}</small>
                `;
                box.appendChild(div);
                i++;
            }
            totalPages = i;
            updateCounter();
        });
    }

    function renderLibrary() {
        const list = document.getElementById('dataList');
        list.innerHTML = `<button class="main-btn" onclick="createNewBook()">+ Create New Book/Vault</button>`;
        // Note: Library management is local or Firebase-based as per previous versions
    }

    function createNewBook() {
        const name = prompt("Enter Name:");
        if(name) window.location.href = "?id=" + name.replace(/\s+/g, '_');
    }

    function showPanel(id, el) {
        document.querySelectorAll('.panel-container, .tab').forEach(x => x.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function nextPage() { if(currentPage < totalPages-1) { document.getElementById('flipSound').play(); document.getElementById('page-'+currentPage).classList.add('flipped'); currentPage++; updateCounter(); } }
    function prevPage() { if(currentPage > 0) { document.getElementById('flipSound').play(); currentPage--; document.getElementById('page-'+currentPage).classList.remove('flipped'); updateCounter(); } }
    function updateCounter() { document.getElementById('pageCounter').innerText = (currentPage+1) + " / " + totalPages; }

    init();
</script>
</body>
</html>
